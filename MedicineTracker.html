<!DOCTYPE html>
<html>
<head>
    <title>MedTrack</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            margin: 0;
            padding: 20px;
            color: #2c3e50;
            max-width: 1300px;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .content-wrapper {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }
        h1 {
            color: #3498db;
            text-align: center;
            margin-bottom: 20px;
            font-size: 2em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        .medicine-form {
            background-color: white;
            border-radius: 12px;
            padding: 25px;
            margin: 20px auto;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            max-width: 900px;
            border: 2px solid #e0e0e0;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .medicine-form h2 {
            text-align: center;
            color: #3498db;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        #medicineInfo {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            width: 100%;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        .schedule-container {
            background-color: white;
            border-radius: 10px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-x: auto;
            width: 100%;
            max-width: 1000px;
            box-sizing: border-box;
        }
        .schedule-scroll {
            max-width: 100%;
            overflow-x: auto;
            padding: 10px;
        }
        .schedule-grid {
            display: grid;
            grid-template-columns: 70px repeat(7, 1fr);
            gap: 1px;
            background-color: #e0e0e0;
            border: 1px solid #ddd;
            min-width: 700px;
            position: relative;
            border-radius: 5px;
            overflow: hidden;
            margin: 0 auto;
        }
        .hour-cell {
            background-color: white;
            padding: 6px;
            text-align: center;
            min-height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: background-color 0.3s ease;
            font-size: 0.9em;
        }
        .hour-cell:hover {
            background-color: #f8f9fa;
        }
        .hour-cell.medication-time {
            background-color: #e3f2fd;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: stretch;
            padding: 4px;
            font-size: 0.8em;
            line-height: 1.2;
            min-height: 40px;
            height: auto;
        }
        .medication-entry {
            background-color: white;
            border: 1px solid #bbdefb;
            border-radius: 4px;
            margin: 2px 0;
            padding: 4px;
            width: 100%;
            box-sizing: border-box;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .medication-entry.selected {
            background-color: #e3f2fd;
            border: 2px solid #3498db;
            box-shadow: 0 2px 5px rgba(52,152,219,0.2);
        }
        .medication-name {
            font-weight: bold;
            margin-bottom: 2px;
            color: #1976d2;
            word-break: break-word;
            font-size: 0.9em;
        }
        .medication-dosage {
            font-size: 0.8em;
            color: #546e7a;
            word-break: break-word;
        }
        .medication-pattern {
            font-size: 0.7em;
            color: #666;
            font-style: italic;
        }
        .medication-expiry {
            font-size: 0.75em;
            color: #e74c3c;
            margin-top: 2px;
        }
        .expiring-soon {
            color: #f39c12;
        }
        .expired {
            color: #c0392b;
            font-weight: bold;
        }
        .hour-cell.hour-label {
            background-color: #f8f9fa;
            font-weight: bold;
            position: sticky;
            left: 0;
            z-index: 1;
            text-align: right;
            padding-right: 10px;
            color: #455a64;
            border-right: 1px solid #ddd;
            font-size: 0.9em;
        }
        .hour-cell.day-header {
            background-color: #f8f9fa;
            font-weight: bold;
            padding: 8px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 1;
            color: #455a64;
            font-size: 0.9em;
        }
        .export-button {
            display: block;
            margin: 0 auto 30px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 12px 24px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .export-button:hover {
            background-color: #45a049;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .button-container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto 30px;
            display: flex;
            justify-content: center;
            gap: 20px;
        }
        .clear-button {
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 12px 24px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .clear-button:hover {
            background-color: #c0392b;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .search-container {
            margin-bottom: 20px;
        }
        .search-options {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .search-option {
            padding: 10px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            cursor: pointer;
            background-color: #fff;
            transition: all 0.3s ease;
            font-weight: 500;
            flex: 1;
            text-align: center;
        }
        .search-option:hover {
            background-color: #f5f7fa;
            border-color: #3498db;
        }
        .search-option.active {
            background-color: #3498db;
            border-color: #3498db;
            color: white;
        }
        .search-input-container {
            position: relative;
        }
        .input-group {
            width: 100%;
            max-width: 450px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            text-align: center;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            border: 1px solid #e8e8e8;
            transition: all 0.3s ease;
        }
        .input-group:hover {
            border-color: #3498db;
            box-shadow: 0 2px 8px rgba(52,152,219,0.1);
        }
        .input-group label {
            font-weight: 500;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .input-group label i {
            color: #3498db;
            font-size: 1.2em;
        }
        .date-input-wrapper {
            position: relative;
            width: 100%;
            max-width: 350px;
        }
        .date-input-wrapper::after {
            content: '';
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            font-size: 1.2em;
            color: #3498db;
        }
        .search-input[type="date"] {
            width: 100%;
            padding: 12px 20px;
            font-size: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            transition: all 0.3s ease;
            background-color: white;
            height: 45px;
            box-sizing: border-box;
            text-align: center;
            color: #2c3e50;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
        }
        .search-input[type="date"]:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
            outline: none;
        }
        .search-input[type="date"]::-webkit-calendar-picker-indicator {
            opacity: 0;
            position: absolute;
            right: 0;
            top: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        .date-hint {
            font-size: 0.85em;
            color: #7f8c8d;
            margin-top: 5px;
            font-style: italic;
        }
        .search-input {
            width: 100%;
            max-width: 350px;
            padding: 12px 20px;
            font-size: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            transition: all 0.3s ease;
            background-color: white;
            height: 45px;
            box-sizing: border-box;
            text-align: center;
        }
        .search-input:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }
        .autocomplete-items {
            position: absolute;
            border: 1px solid #e0e0e0;
            border-top: none;
            z-index: 99;
            top: 100%;
            left: 0;
            right: 0;
            border-radius: 0 0 5px 5px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            background-color: white;
            max-height: 300px;
            overflow-y: auto;
        }
        .autocomplete-items div {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }
        .autocomplete-items div:hover {
            background-color: #f5f7fa;
        }
        .autocomplete-items .medicine-details {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
            line-height: 1.4;
        }
        .autocomplete-items .warnings {
            color: #e74c3c;
            font-size: 0.85em;
            margin-top: 5px;
        }
        #customSection {
            display: none;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            margin-top: 10px;
        }
        #customSection.show {
            display: block;
        }
        #customSection label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 500;
        }
        .time-option {
            padding: 8px 16px;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            background-color: #f8f9fa;
            transition: all 0.3s ease;
        }
        .time-option.active {
            background-color: #e3f2fd;
            border-color: #3498db;
            color: #1976d2;
        }
        #medicineTable {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 30px auto;
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        #medicineTable th {
            background-color: #f8f9fa;
            color: #455a64;
            padding: 12px;
            text-align: left;
            border-bottom: 2px solid #e0e0e0;
        }
        #medicineTable td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
        }
        #medicineTable tr:hover {
            background-color: #f5f7fa;
        }
        .time-selection {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            padding: 20px;
            border: 1px solid #e8e8e8;
            border-radius: 12px;
            background-color: white;
            margin: 20px auto;
            width: 100%;
            max-width: 700px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        .time-selection:hover {
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        .time-checkbox {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #e8e8e8;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-weight: 600;
            color: #2c3e50;
            user-select: none;
            font-size: 1em;
            letter-spacing: 0.5px;
        }
        .time-checkbox:hover {
            background-color: #e3f2fd;
            border-color: #3498db;
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(52,152,219,0.2);
        }
        .time-checkbox input[type="checkbox"] {
            transform: scale(1.5);
            cursor: pointer;
            accent-color: #3498db;
        }
        .time-checkbox.checked {
            background-color: #e3f2fd;
            border-color: #3498db;
            color: #1976d2;
            box-shadow: 0 4px 12px rgba(52,152,219,0.2);
        }
        .day-selection-wrapper {
            width: 100%;
            max-width: 800px;
            margin: 0 auto 20px;
            text-align: center;
            background-color: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 1px solid #e8e8e8;
            transition: all 0.3s ease;
        }
        .day-selection-wrapper:hover {
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        .day-pattern-options {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
            justify-content: center;
        }
        .day-pattern-option {
            padding: 15px 30px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            background-color: #fff;
            transition: all 0.3s ease;
            font-weight: 600;
            flex: 0 1 auto;
            text-align: center;
            min-width: 180px;
            color: #2c3e50;
            font-size: 1.1em;
            letter-spacing: 0.5px;
        }
        .day-pattern-option:hover {
            background-color: #f5f7fa;
            border-color: #3498db;
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(52,152,219,0.2);
        }
        .day-pattern-option.active {
            background-color: #3498db;
            border-color: #3498db;
            color: white;
            box-shadow: 0 6px 15px rgba(52,152,219,0.3);
        }
        .everyday-wrapper {
            text-align: center;
            margin: 25px auto;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 12px;
            border: 1px solid #e8e8e8;
            width: 100%;
            max-width: 450px;
            transition: all 0.3s ease;
        }
        .everyday-wrapper:hover {
            border-color: #3498db;
            box-shadow: 0 4px 12px rgba(52,152,219,0.15);
            transform: translateY(-2px);
        }
        .everyday-wrapper label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.2em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            letter-spacing: 0.5px;
        }
        .everyday-wrapper input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.5);
            cursor: pointer;
            accent-color: #3498db;
        }
        .days-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 25px auto;
            max-width: 300px;
        }
        .days-container label {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 12px;
            border: 2px solid #e8e8e8;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            font-weight: 600;
            color: #2c3e50;
            user-select: none;
            font-size: 1.1em;
            letter-spacing: 0.5px;
            width: 100%;
        }
        .days-container label:hover {
            background-color: #e3f2fd;
            border-color: #3498db;
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(52,152,219,0.2);
        }
        .days-container input[type="checkbox"] {
            transform: scale(1.5);
            cursor: pointer;
            accent-color: #3498db;
        }
        .days-container label.checked {
            background-color: #e3f2fd;
            border-color: #3498db;
            color: #1976d2;
            box-shadow: 0 4px 12px rgba(52,152,219,0.2);
        }
        .days-container label.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #f5f5f5;
            transform: none;
            box-shadow: none;
        }
        button[type="submit"] {
            display: block;
            width: 100%;
            max-width: 300px;
            margin: 30px auto 15px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 12px 24px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        button[type="submit"]:hover {
            background-color: #2980b9;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transform: translateY(-1px);
        }
        button[type="submit"]:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button[type="submit"]:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .form-buttons {
            width: 100%;
            max-width: 450px;
            margin: 30px auto 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        .clear-selected-button {
            width: 100%;
            max-width: 300px;
            background-color: #f39c12;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 12px 24px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .clear-selected-button:hover {
            background-color: #e67e22;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .custom-time-input {
            display: none;
            text-align: center;
            margin-top: 15px;
            width: 100%;
            max-width: 400px;
            margin: 15px auto;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #e8e8e8;
        }
        .custom-time-input label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1em;
        }
        .custom-time-input input[type="time"] {
            width: 100%;
            max-width: 200px;
            padding: 12px 20px;
            font-size: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            transition: all 0.3s ease;
            background-color: white;
            height: 45px;
            box-sizing: border-box;
            text-align: center;
            margin: 0 auto;
            cursor: pointer;
        }
        .custom-time-input input[type="time"]:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
            outline: none;
        }
        .medication-stock {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
            text-align: center;
        }
        .stock-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            width: 100%;
        }
        .stock-count {
            font-weight: bold;
            min-width: 30px;
            text-align: center;
        }
        .remove-entry {
            position: absolute;
            top: 5px;
            right: 5px;
            background: none;
            border: none;
            color: #ff4444;
            cursor: pointer;
            font-size: 16px;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.9);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        .remove-entry:hover {
            color: #cc0000;
            background-color: rgba(255, 255, 255, 1);
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
            transform: scale(1.1);
        }
        @media (max-width: 768px) {
            body {
                padding: 10px;
                -webkit-text-size-adjust: 100%;
                -webkit-tap-highlight-color: transparent;
            }
            .content-wrapper {
                padding: 0 10px;
                width: 100%;
            }
            .medicine-form {
                padding: 15px;
                margin: 10px auto;
                width: 100%;
                box-sizing: border-box;
            }
            .medicine-form h2 {
                font-size: 1.3em;
                margin-bottom: 15px;
            }
            .input-group {
                padding: 10px;
                width: 100%;
                box-sizing: border-box;
            }
            .input-group label {
                font-size: 1em;
            }
            .search-input {
                font-size: 16px; /* Prevents iOS zoom on focus */
                height: 44px; /* Minimum touch target size */
                padding: 10px 15px;
            }
            .day-pattern-options {
                flex-direction: column;
                gap: 10px;
                width: 100%;
            }
            .day-pattern-option {
                width: 100%;
                padding: 12px 15px;
                font-size: 1em;
            }
            .days-container {
                width: 100%;
                max-width: none;
                gap: 10px;
            }
            .days-container label {
                padding: 12px;
                font-size: 1em;
                height: 44px; /* Minimum touch target size */
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .time-selection {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                padding: 15px;
                width: 100%;
                box-sizing: border-box;
            }
            .time-checkbox {
                padding: 12px;
                font-size: 1em;
                height: 44px; /* Minimum touch target size */
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .schedule-container {
                width: 100%;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
            }
            .schedule-grid {
                min-width: 600px;
                font-size: 0.9em;
            }
            .hour-cell {
                padding: 8px;
                min-height: 40px;
            }
            .medication-entry {
                padding: 8px;
                position: relative;
                min-height: 60px;
            }
            .medication-name {
                margin-right: 40px;
                padding-right: 10px;
            }
            .stock-button {
                padding: 8px 12px;
                font-size: 1em;
                min-width: 44px; /* Minimum touch target size */
                min-height: 44px; /* Minimum touch target size */
            }
            .stock-count {
                min-width: 44px; /* Minimum touch target size */
                text-align: center;
            }
            button[type="submit"],
            .clear-button,
            .export-button {
                width: 100%;
                max-width: none;
                height: 44px; /* Minimum touch target size */
                font-size: 1em;
                margin: 10px 0;
            }
            #medicineTable {
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                white-space: nowrap;
            }
            #medicineTable th,
            #medicineTable td {
                padding: 10px;
                font-size: 0.9em;
            }
            /* iOS specific fixes */
            @supports (-webkit-touch-callout: none) {
                .search-input[type="date"] {
                    min-height: 44px;
                }
                .search-input[type="number"] {
                    min-height: 44px;
                }
                select {
                    min-height: 44px;
                }
            }
            /* Android specific fixes */
            @supports not (-webkit-touch-callout: none) {
                .search-input[type="date"] {
                    min-height: 48px;
                }
                .search-input[type="number"] {
                    min-height: 48px;
                }
                select {
                    min-height: 48px;
                }
            }
        }
        /* Tab Styles */
        .tab-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            width: 100%;
            max-width: 900px;
            justify-content: center;
        }
        .tab-button {
            padding: 12px 24px;
            border: none;
            background-color: #f8f9fa;
            color: #2c3e50;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .tab-button:hover {
            background-color: #e3f2fd;
            transform: translateY(-2px);
        }
        .tab-button.active {
            background-color: #3498db;
            color: white;
        }
        .tab-content {
            display: none;
            width: 100%;
        }
        .tab-content.active {
            display: block;
        }
        /* Stock Management Styles */
        .stock-management-container {
            background-color: white;
            border-radius: 12px;
            padding: 25px;
            margin: 20px auto;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            max-width: 900px;
            width: 100%;
        }
        .stock-table-container {
            overflow-x: auto;
            margin-bottom: 20px;
        }
        #stockTable {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 20px 0;
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        #stockTable th {
            background-color: #f8f9fa;
            color: #455a64;
            padding: 12px;
            text-align: left;
            border-bottom: 2px solid #e0e0e0;
        }
        #stockTable td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
        }
        #stockTable tr:hover {
            background-color: #f5f7fa;
        }
        .stock-warning {
            color: #e74c3c;
            font-weight: bold;
            animation: flashWarning 1s infinite;
        }
        @keyframes flashWarning {
            0% { color: #e74c3c; }
            50% { color: #ff0000; }
            100% { color: #e74c3c; }
        }
        .stock-critical {
            color: #ff0000;
            font-weight: bold;
            animation: flashCritical 0.5s infinite;
        }
        @keyframes flashCritical {
            0% { color: #ff0000; }
            50% { color: #ffffff; background-color: #ff0000; }
            100% { color: #ff0000; }
        }
        .stock-info {
            font-size: 0.8em;
            color: #7f8c8d;
            margin-top: 5px;
        }
        .stock-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .stock-button {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .stock-button.decrease {
            background-color: #e74c3c;
            color: white;
        }
        .stock-button.increase {
            background-color: #2ecc71;
            color: white;
        }
        .stock-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .clear-stock-button {
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 12px 24px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .clear-stock-button:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .clear-row-button {
            background-color: #f39c12;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .clear-row-button:hover {
            background-color: #e67e22;
            transform: translateY(-2px);
        }
        .delete-row-button {
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 5px;
        }
        .delete-row-button:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
        }
        .stock-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        .medication-usage {
            font-size: 0.85em;
            color: #7f8c8d;
            margin: 2px 0;
            font-style: italic;
            word-break: break-word;
        }
    </style>
</head>
<body>
    <div class="content-wrapper">
        <h1>MedTrack</h1>
        
        <div class="tab-container">
            <button class="tab-button active" data-tab="add-medicine">Add Medicine</button>
            <button class="tab-button" data-tab="stock-management">Stock Management</button>
        </div>

        <div class="tab-content active" id="add-medicine">
            <div class="medicine-form">
                <h2>Add New Medicine</h2>
                <form id="medicineForm">
                    <div id="medicineInfo">
                        <div class="input-group">
                            <label for="medicineName">Medicine Name:</label>
                            <input type="text" id="medicineName" class="search-input" placeholder="Enter medicine name..." required>
                        </div>
                        
                        <div class="input-group">
                            <label for="medicineUsage">Usage: (Optional)</label>
                            <input type="text" id="medicineUsage" class="search-input" placeholder="Enter medicine usage (e.g., 'For headache', 'After meals')...">
                        </div>

                        <div class="input-group">
                            <label for="dosage">Dosage: (Optional)</label>
                            <input type="text" id="dosage" class="search-input" placeholder="Enter dosage..." style="width: 100%; max-width: 350px; margin: 0 auto;">
                        </div>

                        <div class="input-group">
                            <label for="unitsToTake">Units to Take: (Optional)</label>
                            <input type="number" id="unitsToTake" class="search-input" placeholder="Enter number of units to take..." min="1" value="1" style="width: 100%; max-width: 350px; margin: 0 auto;">
                        </div>

                        <div class="input-group">
                            <label for="stockCount">Initial Stock Count: (Optional)</label>
                            <div style="display: flex; gap: 10px; align-items: center; width: 100%; max-width: 350px; margin: 0 auto;">
                                <input type="number" id="stockCount" name="stockCount" min="0" value="0" class="search-input" placeholder="Enter stock count...">
                            </div>
                        </div>

                        <div class="input-group">
                            <label for="expiryDate">Expiration Date: (Optional)</label>
                            <div class="date-input-wrapper">
                                <input type="date" id="expiryDate" class="search-input" min="">
                            </div>
                            <div class="date-hint">Select the expiration date of your medication</div>
                        </div>
                    </div>
                    
                    <label>Days:</label><br>
                    <div class="day-selection-wrapper">
                        <div class="day-pattern-options">
                            <div class="day-pattern-option active" data-pattern="specific">Specific Days</div>
                            <div class="day-pattern-option" data-pattern="every">Every Selected Day</div>
                        </div>
                        <div class="everyday-wrapper">
                            <label>
                                <input type="checkbox" id="everyday" name="everyday">
                                <span>Select All Days</span>
                            </label>
                        </div>
                        <div class="days-container" id="daysContainer">
                            <label data-day="Monday">
                                <input type="checkbox" name="days" value="Monday">
                                <span>Monday</span>
                            </label>
                            <label data-day="Tuesday">
                                <input type="checkbox" name="days" value="Tuesday">
                                <span>Tuesday</span>
                            </label>
                            <label data-day="Wednesday">
                                <input type="checkbox" name="days" value="Wednesday">
                                <span>Wednesday</span>
                            </label>
                            <label data-day="Thursday">
                                <input type="checkbox" name="days" value="Thursday">
                                <span>Thursday</span>
                            </label>
                            <label data-day="Friday">
                                <input type="checkbox" name="days" value="Friday">
                                <span>Friday</span>
                            </label>
                            <label data-day="Saturday">
                                <input type="checkbox" name="days" value="Saturday">
                                <span>Saturday</span>
                            </label>
                            <label data-day="Sunday">
                                <input type="checkbox" name="days" value="Sunday">
                                <span>Sunday</span>
                            </label>
                        </div>
                    </div><br>
                    
                    <label>Select Times:</label><br>
                    <div class="time-selection" id="timeSelection">
                        <!-- Times will be added by JavaScript -->
                    </div>
                    
                    <div class="form-buttons">
                        <button type="submit">Add Medicine</button>
                        <button type="button" class="clear-selected-button" id="clearSelected">Clear Selected</button>
                        <button type="button" class="clear-button" id="clearSchedule">Clear Schedule</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="tab-content" id="stock-management">
            <div class="stock-management-container">
                <h2>Stock Management</h2>
                <div class="stock-table-container">
                    <table id="stockTable">
                        <thead>
                            <tr>
                                <th>Medicine Name</th>
                                <th>Current Stock</th>
                                <th>Actions</th>
                                <th>Clear</th>
                            </tr>
                        </thead>
                        <tbody id="stockList">
                        </tbody>
                    </table>
                </div>
                <div class="stock-buttons">
                    <button class="clear-stock-button" id="clearAllStock">Clear All Stock</button>
                    <button class="clear-stock-button" id="deleteAllStock" style="background-color: #e74c3c;">Delete All Stock</button>
                </div>
            </div>
        </div>

        <div class="button-container">
            <button class="export-button" id="exportSchedule">Export Schedule to PDF</button>
        </div>

        <div class="schedule-container">
            <div class="schedule-scroll">
                <div class="schedule-grid" id="scheduleGrid">
                    <!-- Grid will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <table id="medicineTable">
            <thead>
                <tr>
                    <th>Medicine Name</th>
                    <th>Dosage</th>
                    <th>Days</th>
                    <th>Times</th>
                    <th>Expiry Date</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="medicineList">
            </tbody>
        </table>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script>
        // Initialize all variables at the top
        let scheduleGrid;
        let medicineName;
        let timeSelection;
        let isEveryPattern = false;
        let medicationStock = {};
        let autoSaveInterval;
        let lastSavedSchedule = '';

        // Initialize everything after DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize DOM elements
            scheduleGrid = document.getElementById('scheduleGrid');
            medicineName = document.getElementById('medicineName');
            timeSelection = document.getElementById('timeSelection');
            const everydayCheckbox = document.getElementById('everyday');
            const dayLabels = document.querySelectorAll('.days-container label');

            // Load saved data
            loadSchedule();
            loadStock();

            // Set up auto-save
            autoSaveInterval = setInterval(() => {
                const currentSchedule = JSON.stringify(getCurrentSchedule());
                if (currentSchedule !== lastSavedSchedule) {
                    saveSchedule();
                    lastSavedSchedule = currentSchedule;
                }
                saveStock();
            }, 30000); // Auto-save every 30 seconds

            // Add auto-save triggers
            document.addEventListener('click', function(e) {
                if (e.target.closest('.medication-entry') || 
                    e.target.closest('.stock-button') || 
                    e.target.closest('.clear-button') || 
                    e.target.closest('.clear-selected-button')) {
                    saveSchedule();
                    saveStock();
                }
            });

            // Add auto-save for form changes
            document.getElementById('medicineForm').addEventListener('change', function() {
                saveSchedule();
                saveStock();
            });

            // Add auto-save for checkbox changes
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    saveSchedule();
                    saveStock();
                });
            });

            // Add auto-save for input changes
            document.querySelectorAll('input[type="text"], input[type="number"], input[type="date"]').forEach(input => {
                input.addEventListener('input', function() {
                    saveSchedule();
                    saveStock();
                });
            });

            // Add auto-save for select changes
            document.querySelectorAll('select').forEach(select => {
                select.addEventListener('change', function() {
                    saveSchedule();
                    saveStock();
                });
            });

            // Initialize day pattern options functionality
            const dayPatternOptions = document.querySelectorAll('.day-pattern-option');
            dayPatternOptions.forEach(option => {
                option.addEventListener('click', function() {
                    dayPatternOptions.forEach(opt => opt.classList.remove('active'));
                    this.classList.add('active');
                    isEveryPattern = this.dataset.pattern === 'every';
                });
            });

            // Initialize everyday checkbox functionality
            everydayCheckbox.addEventListener('change', function() {
                dayLabels.forEach(label => {
                    const checkbox = label.querySelector('input[type="checkbox"]');
                    checkbox.checked = this.checked;
                    checkbox.disabled = this.checked;
                    label.classList.toggle('checked', this.checked);
                    label.classList.toggle('disabled', this.checked);
                });
            });

            // Initialize day checkboxes functionality
            dayLabels.forEach(label => {
                const checkbox = label.querySelector('input[type="checkbox"]');
                
                checkbox.addEventListener('change', function() {
                    label.classList.toggle('checked', this.checked);
                    
                    const allChecked = Array.from(dayLabels).every(l => 
                        l.querySelector('input[type="checkbox"]').checked
                    );
                    everydayCheckbox.checked = allChecked;
                    
                    if (!this.checked || !allChecked) {
                        everydayCheckbox.checked = false;
                        dayLabels.forEach(l => {
                            const cb = l.querySelector('input[type="checkbox"]');
                            cb.disabled = false;
                            l.classList.remove('disabled');
                        });
                    }
                });
            });

            // Generate time selection checkboxes
            for (let hour = 0; hour < 24; hour++) {
                const timeDiv = document.createElement('div');
                timeDiv.className = 'time-checkbox';
                const timeString = hour.toString().padStart(2, '0') + ':00';
                timeDiv.innerHTML = `
                    <input type="checkbox" id="time-${hour}" name="times" value="${timeString}">
                    <label for="time-${hour}">${timeString}</label>
                `;
                timeSelection.appendChild(timeDiv);

                // Add click handler for the time checkbox
                const checkbox = timeDiv.querySelector('input[type="checkbox"]');
                checkbox.addEventListener('change', function() {
                    timeDiv.classList.toggle('checked', this.checked);
                });
            }

            // Generate schedule grid
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            
            // Add empty cell for top-left corner
            const cornerCell = document.createElement('div');
            cornerCell.className = 'hour-cell hour-label';
            cornerCell.textContent = 'Hours';
            scheduleGrid.appendChild(cornerCell);
            
            // Add day headers
            days.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'hour-cell day-header';
                dayHeader.textContent = day;
                scheduleGrid.appendChild(dayHeader);
            });

            // Add hour rows
            for (let hour = 0; hour < 24; hour++) {
                const timeString = hour.toString().padStart(2, '0') + ':00';
                
                // Add hour label first
                const hourLabel = document.createElement('div');
                hourLabel.className = 'hour-cell hour-label';
                hourLabel.textContent = timeString;
                scheduleGrid.appendChild(hourLabel);
                
                // Add day cells
                days.forEach(day => {
                    const cell = document.createElement('div');
                    cell.className = 'hour-cell';
                    cell.dataset.day = day;
                    cell.dataset.time = timeString;
                    scheduleGrid.appendChild(cell);
                });
            }

            // Set minimum date for expiry date input
            const expiryDateInput = document.getElementById('expiryDate');
            const today = new Date();
            const formattedDate = today.toISOString().split('T')[0];
            expiryDateInput.min = formattedDate;

            // Add click handler for medication entries
            document.addEventListener('click', function(e) {
                const medicationEntry = e.target.closest('.medication-entry');
                if (medicationEntry) {
                    medicationEntry.classList.toggle('selected');
                }
            });

            // Add clear selected functionality
            document.getElementById('clearSelected').addEventListener('click', function() {
                const selectedEntries = document.querySelectorAll('.medication-entry.selected');
                if (selectedEntries.length === 0) {
                    alert('Please select medications to clear.');
                    return;
                }

                if (confirm(`Are you sure you want to clear ${selectedEntries.length} selected medication(s)?`)) {
                    selectedEntries.forEach(entry => {
                        const cell = entry.closest('.hour-cell');
                        cell.classList.remove('medication-time');
                        cell.innerHTML = '';
                    });
                    saveSchedule();
                }
            });

            // Add tab switching functionality
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', function() {
                    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    this.classList.add('active');
                    document.getElementById(this.dataset.tab).classList.add('active');
                });
            });

            // Add sync after loading data
            loadSchedule();
            loadStock();
            syncScheduleAndStock();
            
            // Add periodic sync
            setInterval(syncScheduleAndStock, 60000); // Sync every minute
        });

        // Auto-save functionality
        function saveSchedule() {
            const scheduleData = {
                medications: Array.from(document.querySelectorAll('.medication-entry')).map(entry => {
                    const medicineName = entry.querySelector('.medication-name').textContent;
                    const stockData = medicationStock[medicineName] || {
                        current: 0,
                        weeklyUsage: 1,
                        lastUpdated: new Date().toISOString()
                    };
                    
                    return {
                        time: entry.closest('.hour-cell').dataset.time,
                        day: entry.closest('.hour-cell').dataset.day,
                        name: medicineName,
                        dosage: entry.querySelector('.medication-dosage')?.textContent,
                        expiry: entry.querySelector('.medication-expiry')?.textContent,
                        expiryClass: entry.querySelector('.medication-expiry')?.className,
                        isEveryWeek: entry.querySelector('.medication-pattern') !== null,
                        usage: entry.querySelector('.medication-usage')?.textContent,
                        stock: stockData
                    };
                }),
                lastSaved: new Date().toISOString()
            };
            localStorage.setItem('medicineSchedule', JSON.stringify(scheduleData));
            lastSavedSchedule = JSON.stringify(scheduleData);
        }

        function loadSchedule() {
            const savedData = localStorage.getItem('medicineSchedule');
            if (savedData) {
                const scheduleData = JSON.parse(savedData);
                lastSavedSchedule = savedData;
                
                // Clear existing schedule first
                document.querySelectorAll('.hour-cell.medication-time').forEach(cell => {
                    cell.classList.remove('medication-time');
                    cell.innerHTML = '';
                });
                
                // Clear medicine list
                document.getElementById('medicineList').innerHTML = '';
                
                // Process each medication
                scheduleData.medications.forEach(med => {
                    // Update medicine list
                    const newRow = document.createElement('tr');
                    newRow.innerHTML = `
                        <td>${med.name}</td>
                        <td>${med.dosage || 'No dosage specified'}</td>
                        <td>${med.day}</td>
                        <td>${med.time}</td>
                        <td class="${med.expiryClass || ''}">${med.expiry || 'No expiry date set'}</td>
                        <td>Active</td>
                    `;
                    document.getElementById('medicineList').appendChild(newRow);
                    
                    // Update schedule grid
                    const cells = document.querySelectorAll(`.hour-cell[data-time="${med.time}"][data-day="${med.day}"]`);
                    cells.forEach(cell => {
                        cell.classList.add('medication-time');
                        const medicationEntry = createMedicationEntry(
                            med.name,
                            med.dosage,
                            '',
                            med.expiry,
                            med.expiryClass,
                            med.isEveryWeek,
                            med.usage
                        );
                        cell.appendChild(medicationEntry);
                    });
                    
                    // Ensure stock data exists
                    if (!medicationStock[med.name]) {
                        medicationStock[med.name] = {
                            current: 0,
                            weeklyUsage: 1,
                            lastUpdated: new Date().toISOString()
                        };
                    }
                });
                
                // Update stock display for all medications
                Object.keys(medicationStock).forEach(medicineName => {
                    updateStockDisplay(medicineName);
                });
                
                // Update stock management view
                updateStockManagement();
            }
        }

        // Auto-save when window is about to close
        window.addEventListener('beforeunload', function() {
            saveSchedule();
            saveStock();
            clearInterval(autoSaveInterval);
        });

        // Update form submission handler
        document.getElementById('medicineForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Get form values
            const medicineName = document.getElementById('medicineName').value.trim();
            const medicineUsage = document.getElementById('medicineUsage').value.trim();
            const dosage = document.getElementById('dosage').value.trim();
            const unitsToTake = parseInt(document.getElementById('unitsToTake').value) || 1;
            const expiryDate = document.getElementById('expiryDate').value;
            const stockCount = parseInt(document.getElementById('stockCount').value) || 0;

            // Validate medicine name
            if (!medicineName) {
                alert('Please enter the medicine name.');
                return;
            }

            // Get selected days
            const selectedDays = Array.from(document.querySelectorAll('input[name="days"]:checked')).map(checkbox => {
                const day = checkbox.value;
                return isEveryPattern ? `Every ${day}` : day;
            });

            if (selectedDays.length === 0) {
                alert('Please select at least one day.');
                return;
            }
            
            // Get selected times
            const selectedTimes = Array.from(document.querySelectorAll('input[name="times"]:checked')).map(checkbox => checkbox.value);

            if (selectedTimes.length === 0) {
                alert('Please select at least one time.');
                return;
            }

            // Calculate weekly usage based on units to take
            const weeklyUsage = selectedDays.length * selectedTimes.length * unitsToTake;
            
            // Format expiry date if provided
            let expiryStatus = '';
            let expiryClass = '';
            
            if (expiryDate) {
                const formattedExpiryDate = new Date(expiryDate).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                const today = new Date();
                const expiryDateObj = new Date(expiryDate);
                
                if (expiryDateObj < today) {
                    expiryStatus = `Expired (${formattedExpiryDate})`;
                    expiryClass = 'expired';
                } else {
                    expiryStatus = `Expires: ${formattedExpiryDate}`;
                }
            }
            
            // Initialize or update stock count
            if (!medicationStock[medicineName]) {
                medicationStock[medicineName] = {
                    current: stockCount,
                    weeklyUsage: weeklyUsage,
                    lastUpdated: new Date().toISOString()
                };
            } else {
                medicationStock[medicineName].current += stockCount;
                medicationStock[medicineName].weeklyUsage = weeklyUsage;
                medicationStock[medicineName].lastUpdated = new Date().toISOString();
            }

            // Update stock display and management
            updateStockDisplay(medicineName);
            updateStockManagement();
            saveStock();

            // Add to medicine list
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>${medicineName}</td>
                <td>${dosage ? `${dosage} (${unitsToTake} units)` : 'No dosage specified'}</td>
                <td>${selectedDays.join(', ')}</td>
                <td>${selectedTimes.join(', ')}</td>
                <td class="${expiryClass}">${expiryStatus || 'No expiry date set'}</td>
                <td>Pending</td>
            `;
            document.getElementById('medicineList').appendChild(newRow);
            
            // Add to schedule grid
            selectedDays.forEach(dayPattern => {
                const day = isEveryPattern ? dayPattern.replace('Every ', '') : dayPattern;
                selectedTimes.forEach(time => {
                    const cells = document.querySelectorAll(`.hour-cell[data-day="${day}"][data-time="${time}"]`);
                    
                    cells.forEach(cell => {
                        cell.classList.add('medication-time');
                        const medicationEntry = createMedicationEntry(
                            medicineName,
                            dosage,
                            unitsToTake,
                            expiryStatus,
                            expiryClass,
                            isEveryPattern,
                            medicineUsage
                        );
                        cell.appendChild(medicationEntry);
                    });
                });
            });
            
            // Reset form
            this.reset();
            document.getElementById('unitsToTake').value = 1;
            
            // Reset day selection
            const everydayCheckbox = document.getElementById('everyday');
            const dayCheckboxes = document.querySelectorAll('input[name="days"]');
            everydayCheckbox.checked = false;
            dayCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
                checkbox.disabled = false;
                checkbox.parentElement.classList.remove('checked');
            });

            // Reset time selection
            const timeCheckboxes = document.querySelectorAll('input[name="times"]');
            timeCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
                checkbox.parentElement.classList.remove('checked');
            });

            // Reset day pattern selection
            const dayPatternOptions = document.querySelectorAll('.day-pattern-option');
            dayPatternOptions.forEach(option => {
                option.classList.remove('active');
            });
            dayPatternOptions[0].classList.add('active');
            isEveryPattern = false;

            // Save data
            saveSchedule();
            saveStock();

            // Show stock management tab
            document.querySelector('.tab-button[data-tab="stock-management"]').click();
        });

        // Update medication entry creation function
        function createMedicationEntry(medicineName, dosage, unitsToTake, expiryStatus, expiryClass, isEveryPattern, medicineUsage) {
            const medicationEntry = document.createElement('div');
            medicationEntry.className = 'medication-entry';
            
            // Add stock controls
            const stockControls = document.createElement('div');
            stockControls.className = 'medication-stock';
            stockControls.innerHTML = `
                <div class="stock-controls">
                    <button class="stock-button" onclick="updateStock('${medicineName}', -${unitsToTake})">-</button>
                    <span class="stock-count" data-medicine="${medicineName}">${medicationStock[medicineName].current || 0}</span>
                    <button class="stock-button" onclick="updateStock('${medicineName}', ${unitsToTake})">+</button>
                </div>
            `;
            
            medicationEntry.innerHTML = `
                <div class="medication-name">${medicineName}</div>
                ${medicineUsage ? `<div class="medication-usage">${medicineUsage}</div>` : ''}
                ${dosage ? `<div class="medication-dosage">${dosage} (${unitsToTake} units)</div>` : ''}
                ${expiryStatus ? `<div class="medication-expiry ${expiryClass}">${expiryStatus}</div>` : ''}
                ${isEveryPattern ? '<div class="medication-pattern">Every Week</div>' : ''}
            `;
            
            medicationEntry.appendChild(stockControls);
            return medicationEntry;
        }

        // Update stock tracking functionality
        function updateStock(medicineName, change) {
            if (!medicationStock[medicineName]) {
                medicationStock[medicineName] = {
                    current: 0,
                    weeklyUsage: 0,
                    lastUpdated: new Date().toISOString()
                };
            }
            medicationStock[medicineName].current += change;
            if (medicationStock[medicineName].current < 0) {
                medicationStock[medicineName].current = 0;
            }
            medicationStock[medicineName].lastUpdated = new Date().toISOString();
            
            updateStockDisplay(medicineName);
            updateStockManagement();
            saveStock();
            
            checkStockWarnings(medicineName);
        }
        
        function updateStockDisplay(medicineName) {
            const stockElements = document.querySelectorAll(`.stock-count[data-medicine="${medicineName}"]`);
            stockElements.forEach(element => {
                element.textContent = medicationStock[medicineName].current || 0;
            });
        }
        
        function saveStock() {
            localStorage.setItem('medicationStock', JSON.stringify(medicationStock));
        }
        
        function loadStock() {
            const savedStock = localStorage.getItem('medicationStock');
            if (savedStock) {
                medicationStock = JSON.parse(savedStock);
                
                // Ensure all medications in the schedule have stock data
                document.querySelectorAll('.medication-entry').forEach(entry => {
                    const medicineName = entry.querySelector('.medication-name').textContent;
                    if (!medicationStock[medicineName]) {
                        medicationStock[medicineName] = {
                            current: 0,
                            weeklyUsage: 1,
                            lastUpdated: new Date().toISOString()
                        };
                    }
                });
                
                // Update displays
                Object.keys(medicationStock).forEach(medicineName => {
                    updateStockDisplay(medicineName);
                });
                updateStockManagement();
            }
        }

        // Update PDF export functionality
        document.getElementById('exportSchedule').addEventListener('click', function() {
            const tempContainer = document.createElement('div');
            tempContainer.style.position = 'absolute';
            tempContainer.style.left = '-9999px';
            document.body.appendChild(tempContainer);

            const filteredGrid = document.getElementById('scheduleGrid').cloneNode(true);
            tempContainer.appendChild(filteredGrid);

            // Remove empty hour rows and collect non-empty rows
            const headerCells = Array.from(filteredGrid.children).slice(0, 8);
            let nonEmptyRows = [];

            for (let i = 8; i < filteredGrid.children.length; i += 8) {
                const rowCells = Array.from(filteredGrid.children).slice(i, i + 8);
                const hasMedications = rowCells.some(cell => cell.classList.contains('medication-time'));
                if (hasMedications) {
                    nonEmptyRows.push(rowCells);
                }
            }

            // Clear and rebuild grid
            filteredGrid.innerHTML = '';
            headerCells.forEach(cell => filteredGrid.appendChild(cell.cloneNode(true)));
            
            nonEmptyRows.forEach(rowCells => {
                rowCells.forEach(cell => {
                    const clonedCell = cell.cloneNode(true);
                    // Remove remove buttons
                    const removeButtons = clonedCell.querySelectorAll('.remove-entry');
                    removeButtons.forEach(btn => btn.remove());
                    
                    // Center stock count
                    const stockControls = clonedCell.querySelector('.stock-controls');
                    if (stockControls) {
                        const stockCount = stockControls.querySelector('.stock-count').textContent;
                        stockControls.innerHTML = `<div style="text-align: center; width: 100%;">Units: ${stockCount}</div>`;
                    }
                    
                    filteredGrid.appendChild(clonedCell);
                });
            });

            // Style the filtered grid for export
            filteredGrid.style.display = 'grid';
            filteredGrid.style.gridTemplateColumns = '70px repeat(7, 1fr)';
            filteredGrid.style.gap = '1px';
            filteredGrid.style.backgroundColor = '#e0e0e0';
            filteredGrid.style.border = '1px solid #ddd';
            filteredGrid.style.borderRadius = '5px';
            filteredGrid.style.overflow = 'hidden';
            filteredGrid.style.width = 'fit-content';
            filteredGrid.style.margin = '0 auto';

            // Style cells for export
            filteredGrid.querySelectorAll('.hour-cell').forEach(cell => {
                cell.style.backgroundColor = 'white';
                cell.style.padding = '8px';
                cell.style.minHeight = '40px';
                cell.style.display = 'flex';
                cell.style.alignItems = 'center';
                cell.style.justifyContent = 'center';
                
                if (cell.classList.contains('hour-label')) {
                    cell.style.backgroundColor = '#f8f9fa';
                    cell.style.fontWeight = 'bold';
                    cell.style.textAlign = 'right';
                    cell.style.paddingRight = '15px';
                    cell.style.color = '#455a64';
                    cell.style.borderRight = '1px solid #ddd';
                }
                
                if (cell.classList.contains('day-header')) {
                    cell.style.backgroundColor = '#f8f9fa';
                    cell.style.fontWeight = 'bold';
                    cell.style.color = '#455a64';
                }

                if (cell.classList.contains('medication-time')) {
                    cell.style.backgroundColor = '#e3f2fd';
                    cell.style.border = '1px solid #bbdefb';
                    cell.style.flexDirection = 'column';
                    cell.style.alignItems = 'center';
                    cell.style.justifyContent = 'center';
                    
                    // Remove stock controls from medication entries
                    const stockControls = cell.querySelector('.stock-controls');
                    if (stockControls) {
                        stockControls.remove();
                    }
                }
            });

            // Export to PDF
            html2canvas(filteredGrid, {
                scale: 2,
                logging: false,
                useCORS: true,
                backgroundColor: '#f5f7fa'
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jspdf.jsPDF({
                    orientation: 'landscape',
                    unit: 'mm',
                    format: 'a4'
                });
                
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                const imgWidth = pageWidth - 20;
                const imgHeight = canvas.height * imgWidth / canvas.width;
                
                pdf.addImage(imgData, 'PNG', 10, (pageHeight - imgHeight) / 2, imgWidth, imgHeight);
                pdf.save('medicine_schedule.pdf');

                tempContainer.remove();
            });
        });

        // Update clear schedule functionality
        document.getElementById('clearSchedule').addEventListener('click', function() {
            if (confirm('Are you sure you want to clear the entire schedule and all stock? This action cannot be undone.')) {
                // Clear the schedule grid
                document.querySelectorAll('.hour-cell.medication-time').forEach(cell => {
                    cell.classList.remove('medication-time');
                    cell.innerHTML = '';
                });

                // Clear the medicine list table
                document.getElementById('medicineList').innerHTML = '';

                // Clear all stock
                medicationStock = {};
                updateStockManagement();
                saveStock();

                // Clear local storage
                localStorage.removeItem('medicineSchedule');
                localStorage.removeItem('medicationStock');
                lastSavedSchedule = '';
            }
        });

        // Update stock management functionality
        function updateStockManagement() {
            const stockList = document.getElementById('stockList');
            stockList.innerHTML = '';
            
            Object.entries(medicationStock).forEach(([medicineName, stock]) => {
                const row = document.createElement('tr');
                const weeksOfStock = stock.current / stock.weeklyUsage;
                let warningClass = '';
                
                if (weeksOfStock <= 0.5) {
                    warningClass = 'stock-critical';
                } else if (weeksOfStock <= 1) {
                    warningClass = 'stock-warning';
                }
                
                row.innerHTML = `
                    <td>${medicineName}</td>
                    <td class="${warningClass}">${stock.current}</td>
                    <td>
                        <div class="stock-actions">
                            <button class="stock-button decrease" onclick="updateStock('${medicineName}', -1)">-</button>
                            <button class="stock-button increase" onclick="updateStock('${medicineName}', 1)">+</button>
                        </div>
                    </td>
                    <td>
                        <button class="clear-row-button" onclick="clearStock('${medicineName}')">Clear</button>
                        <button class="delete-row-button" onclick="deleteStock('${medicineName}')">Delete</button>
                    </td>
                `;
                
                // Add stock info with warning indicators
                const infoCell = document.createElement('td');
                let warningText = '';
                if (weeksOfStock <= 0.5) {
                    warningText = '<div class="stock-critical">CRITICAL STOCK LEVEL!</div>';
                } else if (weeksOfStock <= 1) {
                    warningText = '<div class="stock-warning">Low Stock Warning</div>';
                }
                
                infoCell.innerHTML = `
                    <div class="stock-info">
                        ${warningText}
                        Weekly Usage: ${stock.weeklyUsage}<br>
                        Weeks of Stock: ${weeksOfStock.toFixed(1)}<br>
                        Last Updated: ${new Date(stock.lastUpdated).toLocaleDateString()}
                    </div>
                `;
                row.appendChild(infoCell);
                
                stockList.appendChild(row);
            });
        }

        function checkStockWarnings(medicineName) {
            const stock = medicationStock[medicineName];
            if (!stock) return;

            const weeksOfStock = stock.current / stock.weeklyUsage;
            
            // Remove alert calls and only update visual indicators
            if (weeksOfStock <= 0.5) {
                // Critical stock - will show red flashing in stock tab
                updateStockManagement();
            } else if (weeksOfStock <= 1) {
                // Low stock - will show orange flashing in stock tab
                updateStockManagement();
            }
        }

        function clearStock(medicineName) {
            if (confirm(`Are you sure you want to clear stock for ${medicineName}?`)) {
                medicationStock[medicineName] = {
                    current: 0,
                    weeklyUsage: medicationStock[medicineName].weeklyUsage,
                    lastUpdated: new Date().toISOString()
                };
                updateStockManagement();
                saveStock();
            }
        }

        function deleteStock(medicineName) {
            if (confirm(`Are you sure you want to delete ${medicineName} from stock management? This will remove all stock data and cannot be undone.`)) {
                // Remove from medicationStock
                delete medicationStock[medicineName];
                
                // Remove from schedule grid
                document.querySelectorAll(`.medication-entry`).forEach(entry => {
                    if (entry.querySelector('.medication-name').textContent === medicineName) {
                        const cell = entry.closest('.hour-cell');
                        cell.classList.remove('medication-time');
                        cell.innerHTML = '';
                    }
                });
                
                // Remove from medicine list
                const medicineList = document.getElementById('medicineList');
                Array.from(medicineList.querySelectorAll('tr')).forEach(row => {
                    if (row.cells[0].textContent === medicineName) {
                        row.remove();
                    }
                });
                
                // Update display and save
                updateStockManagement();
                saveStock();
            }
        }

        document.getElementById('clearAllStock').addEventListener('click', function() {
            if (confirm('Are you sure you want to clear all stock? This action cannot be undone.')) {
                Object.keys(medicationStock).forEach(medicineName => {
                    medicationStock[medicineName] = {
                        current: 0,
                        weeklyUsage: medicationStock[medicineName].weeklyUsage,
                        lastUpdated: new Date().toISOString()
                    };
                });
                updateStockManagement();
                saveStock();
            }
        });

        document.getElementById('deleteAllStock').addEventListener('click', function() {
            if (confirm('Are you sure you want to delete all stock data? This will remove all medications from stock management and cannot be undone.')) {
                // Clear medicationStock
                medicationStock = {};
                
                // Clear schedule grid
                document.querySelectorAll('.hour-cell.medication-time').forEach(cell => {
                    cell.classList.remove('medication-time');
                    cell.innerHTML = '';
                });
                
                // Clear medicine list
                document.getElementById('medicineList').innerHTML = '';
                
                // Update display and save
                updateStockManagement();
                saveStock();
            }
        });

        // Add function to get current schedule state
        function getCurrentSchedule() {
            return {
                medications: Array.from(document.querySelectorAll('.medication-entry')).map(entry => ({
                    time: entry.closest('.hour-cell').dataset.time,
                    day: entry.closest('.hour-cell').dataset.day,
                    name: entry.querySelector('.medication-name').textContent,
                    dosage: entry.querySelector('.medication-dosage')?.textContent,
                    expiry: entry.querySelector('.medication-expiry')?.textContent,
                    expiryClass: entry.querySelector('.medication-expiry')?.className,
                    isEveryWeek: entry.querySelector('.medication-pattern') !== null,
                    usage: entry.querySelector('.medication-usage')?.textContent
                }))
            };
        }

        // Add sync function to ensure schedule and stock are in sync
        function syncScheduleAndStock() {
            // Get all unique medicine names from schedule
            const scheduleMedicines = new Set(
                Array.from(document.querySelectorAll('.medication-entry'))
                    .map(entry => entry.querySelector('.medication-name').textContent)
            );
            
            // Remove stock data for medicines not in schedule
            Object.keys(medicationStock).forEach(medicineName => {
                if (!scheduleMedicines.has(medicineName)) {
                    delete medicationStock[medicineName];
                }
            });
            
            // Ensure all medicines in schedule have stock data
            scheduleMedicines.forEach(medicineName => {
                if (!medicationStock[medicineName]) {
                    medicationStock[medicineName] = {
                        current: 0,
                        weeklyUsage: 1,
                        lastUpdated: new Date().toISOString()
                    };
                }
            });
            
            // Update displays and save
            updateStockManagement();
            saveStock();
            saveSchedule();
        }
    </script>
</body>
</html> 